########################################################################################################################
#□□□□□□□□■□■□□■□□□□■□□■□□□■■■■■■■□■□□□■■■■■■□□□■□□□□■■□□□□□■#
#□■■■■■□□■□■□□■■■■■■□□■□□□■■■■■■■□■□□□■□□□□■■■■■□□■■■■■■■□□■#
#□□□□□■□□■□■□□■■■■■■□□■■■□□□■■□□□□■□□□■□□□□■□□□■□□■■■■■■■□□■#
#□□□□■■□□■□■□□■□□□□■□□■□□□□□■■□□□□■□□□■□□□□■■■■■□□□□■■□□□□□■#
#□□□□■■□□■■■□□■■■■■■□□■□□□□□■■□□□□■■■□■■■■■■■■■■□□□□■■□□□□□■#
#□□□□■■□□■■■□□■■■■■■□□■□□□□□■■■□□□■■■□□□□□□□□□□■□□□□■■■□□□□■#
#□□□■■■□□■□■□□□■■■■■■■■□□□□■■■■■□□■□□□□□■■■■■■■■□□□■■■■■□□□■#
#□□■■■□□□■□■□□□□□□□□□□■□□□■■■□■■■□■□□□□□□□□□□□□■□□■■■□■■■□□■#
#□■■■□□□□■□■□□□□□□□□□□■□□■■■□□□■■□■□□□□□□□□□□□□■□■■■□□□■■□□■#
#□■□□□□□□■□■□□□■■■■■■■■□□□□□□□□□□□■□□□□□■■■■■■■■□□■□□□□□□□□■#
#□□□□□□□□■□■□□□■■□□□□□□□□□□□□□□□□□■□□□□□■□□□□□□□□□□□□□□□□□□■#
#□□□□□□□□■□■□□□■■■■■■■■■□□□□□□□□□□■□□□□□■■■■■■■■□□□□□□□□□□□■#
##############################################################################################################################################################################################################
#□□□□□□□□□□□■■□□□□■□□□□□□□□□□■■□□□□□□■■■■■■■□■□□□□□■■□■□□□■□■□□■□□□□□□□□□□□□□□□□□□■■■■■■■■■■□□■■■■■■■□■#
#□■■■■■■□□■■■■■■■□■□□□□□□□□□□■■□□□□□□□□■■□□□□■□□□□□■■□■□□□■□■□□■□□□■■■■■■■■■□□□□□□□□□□□□□□■■□□■■■■■■■□■#
#□■■□□■■□□■■■■■■■□■□□□□□□□□□□■■■□□□□□□□■■□□□□■□□□□□■■□■□□□■□■□□■□□□□■■□□□■□□□□□□□□□□□□□□□□■■□□□□■■□□□□■#
#□■□□□■■□□□□■■□□□□■□□□□□□□□□■■■■■□□□□□■■■■■■■■□□□□■■□□■■■■■□■□□■□□□□■■□□□■□□□□□□□□□□□□□□□□■■□□□□■■□□□□■#
#□□□□□■■□□□□■■□□□□■■■□□□□■■■■■□■■■■■□□■■■■■□□■□□□□■■□□■■■■■□■■■■□□□□■■□□□■□□□□□□□□□□□□□□□■■□□□□□■■□□□□■#
#□□□□■■■□□□□■■■□□□■■■□□□□■■■□□□□□■■■■■■■□■■■□■□□□□■■□□■□□□■□■■■■□□□□■■□□□■□□□□□□□■■■■■■■■■■■■□□□■■■□□□■#
#□□□■■■□□□□■■■■■□□■□□□□□□□□□□□□□□□□□■■□□□□■□□■□□□■■□□□■□□□■□■□□■□□■■■■■■■■■■□□□□□□□□□□□□□□□□□□□■■■■■□□■#
#□□■■■□□□□■■■□■■■□■□□□□□■■■■■■■■■■■■□□□■■■■■■■□□□■■□□□■■■■■□■□□■□□□□□□■■□□□□□□□□□□□■■■■■■■■■□□■■■□■■■□■#
#□■■■□□□□■■■□□□■■□■□□□□□□□□□□■■□□□□□□□□■■■□■■■□□□■■□□□■■■■■□■□□■□□□□□□■■□□□□□□□□□□□■■□□□□□■■□■■■□□□■■□■#
#□■■■■■■■□■□□□□□□□■□□□□□□□□□□■■□□□□□□□□■□□□□□■□□■■□□□□□□□□□□■□□■□■■■■■■■■■■■■□□□□□□■■□□□□□■■□□□□□□□□□□■#
#□□□□□□□□□□□□□□□□□■□□□□□□□□□□■■□□□□□□□□■■□□□■■□□■■□□□□□□□□□□■□□■□□□□□□□□□□□□□□□□□□□■■□□□□□■■□□□□□□□□□□■#
#□□□□□□□□□□□□□□□□□■□□□□□□□□□□■■□□□□□□□□■■■■■■■□□■■□□□□□□□□□□■□□■□□□□□□□□□□□□□□□□□□□■■■■■■■■■□□□□□□□□□□■#
#□□□□□□□□□□□□□□□□□□□□□□□□□□□□■■□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□□#
##############################################################################################################################################################################################################

import os, sys, json, random, threading, csv
from ursina import *
from ursina.prefabs.first_person_controller import FirstPersonController

app = Ursina()

block_types = {
    'grass': load_texture('assets/grass.png'),
    'stone': load_texture('assets/stone.png'),
    'gold': load_texture('assets/gold.png'),
    'lava': load_texture('assets/lava.png'),
    'brick': load_texture('assets/brick.png'),
    'cobble': load_texture('assets/cobble.png'),
    'dirt': load_texture('assets/dirt.png'),
    'oak_log': load_texture('assets/oak_log.png'),
    'oak_plank': load_texture('assets/oak_plank.png'),
}

block_name_list = list(block_types.keys())

hotbar = [
    'grass', 'stone', 'dirt', 'oak_log', 'oak_plank',
    'brick', 'cobble', 'gold', 'lava'
]
current_slot = 0

jump_height = 2
jump_duration = 0.5
gravity_scale = 1
mouse_sensitivity = Vec2(40, 40)
run_speed = 8

map_settings = {
    "비행": True,
    "설치": True,
    "파괴": True,
}

window.fps_counter.enabled = False
window.exit_button.visible = False
window.borderless = False

punch = Audio('assets/punch', autoplay=False)
jump = Audio('assets/jump', autoplay=False)

is_flying = False
voxels = []

player_pos_text = Text(
    text='',
    position=window.top_left + Vec2(0.05, -0.05),
    origin=(-0.3, 0),
    background=False,
    scale=0.8,
    color=color.white,
)

def save_map_csv(filename='map.csv'):
    with open(filename, 'w', newline='') as f:
        writer = csv.writer(f)
        for v in voxels:
            pos = v.position
            name = v.texture.name.split('/')[-1].split('.')[0]
            idx = block_name_list.index(name) if name in block_name_list else 0
            writer.writerow([pos.x, pos.y, pos.z, idx])
        writer.writerow(['#설정'])
        for key, value in map_settings.items():
            if isinstance(value, (list, dict)):
                value = json.dumps(value)
            writer.writerow([key, value])

def load_map_csv(filename='map.csv'):
    global map_settings
    try:
        with open(filename, 'r') as f:
            reader = csv.reader(f)
            for v in voxels[:]:
                voxels.remove(v)
                destroy(v)

            blocks_section = True
            temp_settings = {}
            for row in reader:
                if not row:
                    continue
                if row[0] == '#설정':
                    blocks_section = False
                    continue
                if blocks_section:
                    x, y, z, idx = row
                    pos = (float(x), float(y), float(z))
                    idx = int(idx)
                    name = block_name_list[idx] if idx < len(block_name_list) else 'grass'
                    Voxel(position=pos, texture=block_types[name])
                else:
                    key, value = row[0], row[1]
                    try:
                        value = json.loads(value)
                    except:
                        pass
                    if isinstance(value, str):
                        if value.lower() == 'true':
                            value = True
                        elif value.lower() == 'false':
                            value = False
                    temp_settings[key] = value
            map_settings.update(temp_settings)
    except FileNotFoundError:
        print(f"File {filename} not found.")

def input(key):
    global current_slot, is_flying
    if key.isdigit():
        s = int(key) - 1
        if 0 <= s < 9:
            current_slot = s
            update_hand_texture()
    if key == 'escape':
        punch.play()
        save_map_csv()
        application.quit()
    if key == 'space':
        jump.play()
    if key == 'k':
        save_map_csv()
        punch.play()
    if key == 'l':
        load_map_csv()
        punch.play()
    if key == 'f' and map_settings.get("비행", True):
        is_flying = not is_flying
        if is_flying:
            player.gravity = 0
            player.velocity = Vec3(0, 0, 0)
            punch.play()
        else:
            player.gravity = gravity_scale
            player.velocity = Vec3(0, -1, 0)
            punch.play()

def update_hand_texture():
    hand.texture = block_types.get(hotbar[current_slot], block_types['grass'])

sky = Entity(parent=scene, model='sphere', texture=load_texture('assets/sky.jpg'), scale=500, double_sided=True)

hand = Entity(parent=camera.ui, model='assets/block', texture=block_types[hotbar[current_slot]], scale=0.2, rotation=Vec3(-10, -10, 10), position=Vec2(0.6, -0.6))

class CustomPlayer(FirstPersonController):
    def update(self):
        self.rotation_y += mouse.velocity[0] * self.mouse_sensitivity.x
        self.camera_pivot.rotation_x -= mouse.velocity[1] * self.mouse_sensitivity.y
        self.camera_pivot.rotation_x = clamp(self.camera_pivot.rotation_x, -90, 90)

        if not is_flying:
            super().update()
        else:
            d = Vec3(self.forward*(held_keys['w']-held_keys['s']) + self.right*(held_keys['d']-held_keys['a'])).normalized()
            ms = self.speed * time.dt
            self.position += d * ms
            if held_keys['q']:
                self.position += Vec3(0, ms, 0)
            if held_keys['e']:
                self.position -= Vec3(0, ms, 0)


        if held_keys['left mouse'] or held_keys['right mouse']:
            hand.position = Vec2(0.4, -0.5)
        else:
            hand.position = Vec2(0.6, -0.6)

class Voxel(Button):
    def __init__(self, position=(0, 0, 0), texture=block_types['grass']):
        super().__init__(
            parent=scene,
            position=position,
            model='assets/block',
            origin_y=0.5,
            texture=texture,
            color=color.color(0, 0, random.uniform(0.9, 1.0)),
            scale=0.5
        )
        voxels.append(self)

    def input(self, key):
        if self.hovered and key == 'right mouse down' and hasattr(mouse, 'normal') and mouse.normal:
            if map_settings.get("설치", True):
                Voxel(position=self.position + mouse.normal, texture=block_types[hotbar[current_slot]])
        if self.hovered and key == 'left mouse down':
            if map_settings.get("파괴", True):
                if self in voxels:
                    voxels.remove(self)
                destroy(self)

for z in range(20):
    for x in range(20):
        Voxel(position=(x, 0, z))

player = CustomPlayer()
player.position = Vec3(10, 2, 10)
player.jump_height = jump_height
player.jump_up_duration = jump_duration
player.mouse_sensitivity = mouse_sensitivity
player.speed = run_speed
player.gravity = gravity_scale

def update():
    pos = player.position
    player_pos_text.text = f'pos: ({int(pos.x)}, {int(pos.y)}, {int(pos.z)})'

app.run()
